# Authorization

NestJS CRUD Automator now ships with a subscriber-style RBAC system. Policies are declared once, discovered automatically, and applied to every generated route without manual guard wiring or controller configuration.

## Enable the Authorization Module

Import `ApiAuthorizationModule` in your root module to boot the discovery service, registry, guard, and engine:

```typescript filename="app.module.ts" copy
import { Module } from "@nestjs/common";
import { TypeOrmModule } from "@nestjs/typeorm";
import { ApiAuthorizationModule } from "@elsikora/nestjs-crud-automator";

@Module({
	imports: [
		TypeOrmModule.forRoot(/* ... */),
		ApiAuthorizationModule, // üëà enables discovery + guard
	],
})
export class AppModule {}
```

> The authorization guard is attached to every generated controller method automatically. No `@UseGuards(ApiAuthorizationGuard)` calls are required.

## Create a Policy

Policies mirror the subscriber system: decorate a class and extend `ApiAuthorizationPolicyBase`. The decorator only needs the entity; policy IDs and priorities default to predictable values.

```typescript filename="policies/user-access.policy.ts" copy
import { ApiAuthorizationPolicy, ApiAuthorizationPolicyBase, EApiRouteType } from "@elsikora/nestjs-crud-automator";
import { UserEntity } from "../user.entity";

@ApiAuthorizationPolicy<UserEntity>({ entity: UserEntity, priority: 200 })
export class UserAccessPolicy extends ApiAuthorizationPolicyBase<UserEntity> {
	onBeforeGet() {
		return this.allow({
			scope: ({ subject }) => ({ where: { id: subject.id } }),
		});
	}

	onBeforeDelete() {
		return this.deny({
			description: "Only administrators can delete users",
			condition: ({ subject }) => !subject.roles.includes("admin"),
		});
	}

	getCustomActionRule(action: string) {
		if (action === "promote") {
			return this.allowForRoles(["admin"]);
		}

		return undefined;
	}
}
```

### Hook Summary

Hook names align with `EApiRouteType`:

- `onBeforeCreate`, `onBeforeGet`, `onBeforeGetList`, `onBeforeUpdate`, `onBeforePartialUpdate`, `onBeforeDelete`
- `getCustomActionRule(action)` handles non-standard methods such as `solve`, `promote`, etc.

Every hook can return:

- `this.allow()` / `this.deny()` helpers
- arrays of rules (priority is `policyPriority + rulePriority`)
- `undefined` to skip authorization for that action

## Subject Resolution

`ApiAuthorizationGuard` –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç `request.user` —á–µ—Ä–µ–∑ `AuthorizationResolveDefaultSubject`, –ø–æ—ç—Ç–æ–º—É –∫–∞–∂–¥–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π `IApiAuthorizationSubject`:

- `id` ‚Äî –ø–µ—Ä–≤–∞—è –Ω–µ–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–∑ `id`, `uuid` –∏–ª–∏ `email`;
- `roles` ‚Äî –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ `roles` (–º–∞—Å—Å–∏–≤) –∏–ª–∏ `role` (–æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞);
- `permissions` ‚Äî –º–∞—Å—Å–∏–≤ –∏–∑ `permissions` –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ `permission`;
- `attributes` ‚Äî –≤–µ—Å—å –∏—Å—Ö–æ–¥–Ω—ã–π –æ–±—ä–µ–∫—Ç `request.user`, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å—á–∏—Ç—ã–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (tenant, organization –∏ —Ç.–¥.).

–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç —Ä–æ–ª–∏ –∏ permissions –≤ `request.user`:

```typescript filename="auth.strategy.ts" copy
const client = await this.clientsService.resolveFromToken(token);

return {
	id: client.id,
	roles: client.roles ?? ["client"],
	permissions: client.permissions ?? ["challenge:read"],,
	tenantId: client.tenantId,
};
```

–ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ä–µ–∑–æ–ª–≤–µ—Ä ‚Äî –≥–ª–∞–≤–Ω–æ–µ, —á—Ç–æ–±—ã –Ω–∞ –≤—ã—Ö–æ–¥–µ –æ—Å—Ç–∞–≤–∞–ª—Å—è –æ–±—ä–µ–∫—Ç `IApiAuthorizationSubject`.

## Decision Resource Lifecycle

1. Guard –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞, –ø–æ—ç—Ç–æ–º—É –≤ –¥–≤–∏–∂–æ–∫ –ª–µ—Ç–∏—Ç `resource: undefined`.
2. –ú–µ—Ç–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Ö–æ–¥, –≤—ã–ø–æ–ª–Ω—è–µ—Ç `service.get / update / create` –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `AuthorizationDecisionAttachResource`, —á—Ç–æ–±—ã –ø–æ–º–µ—Å—Ç–∏—Ç—å —Å—É—â–Ω–æ—Å—Ç—å –≤ `authorizationDecision.resource`.
3. BEFORE-–ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –≤–∏–¥—è—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, AFTER/AFTER_ERROR –∏ `AuthorizationDecisionApplyResult` –ø–æ–ª—É—á–∞—é—Ç —Ç–æ—Ç –∂–µ —ç–∫–∑–µ–º–ø–ª—è—Ä —Å—É—â–Ω–æ—Å—Ç–∏, —á—Ç–æ –≤–µ—Ä–Ω—É–ª —Å–µ—Ä–≤–∏—Å.
4. –≠—Ç–æ –∏–∑–±–∞–≤–ª—è–µ—Ç guard –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—ã/–ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

## Context, Scope, and Result Transform

Each rule can define:

- `condition(context)` ‚Üí async boolean
- `scope(context)` ‚Üí returns `FindOptionsWhere` fragments (merged with existing filters)
- `resultTransform(result, context)` ‚Üí sequential transformations for masking or enrichment

The engine evaluates rules in priority order. The first matching `DENY` short-circuits; otherwise all matching `ALLOW` rules contribute scope and transforms. Scopes are applied to controller queries (`GET`, `GET_LIST`, `UPDATE`, `DELETE`, etc.) before hitting your service.

### Result Transform Example

`resultTransform(result, context)` ‚Äî —É–¥–æ–±–Ω–æ–µ –º–µ—Å—Ç–æ, —á—Ç–æ–±—ã –∑–∞–º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—è –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `subject` –∏ (–Ω–∞ AFTER-—Å—Ç–∞–¥–∏—è—Ö) `resource`:

```typescript filename="policies/challenge.policy.ts" copy
onBeforeGet() {
	return this.allow({
		resultTransform: (result, { subject }) => {
			if (result && !subject.roles.includes("admin")) {
				delete (result as Challenge).secretKey;
			}

			return result;
		},
	});
}

onBeforeGetList() {
	return this.allow({
		resultTransform: (result) => {
			if (Array.isArray(result)) {
				for (const item of result) {
					delete (item as Challenge).secretKey;
				}
			}

			return result;
		},
	});
}
```

- –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª —Å `resultTransform` ‚Äî –¥–≤–∏–∂–æ–∫ –¥–æ–±–∞–≤–∏—Ç –∏—Ö –≤ `decision.transforms` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.
- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Ç–µ–º –∂–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º, —á—Ç–æ –∏ —É—Å–ª–æ–≤–∏—è/—Å–∫–æ—É–ø—ã, –ø–æ—ç—Ç–æ–º—É –º–æ–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å —Ä–æ–ª–∏, permissions –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å.

### Typed Result Payloads

–ö–∞–∂–¥—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ö—É–∫ —Ç–µ–ø–µ—Ä—å –∑–Ω–∞–µ—Ç —Ç–æ—á–Ω—ã–π —Ç–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –ø–æ—ç—Ç–æ–º—É `resultTransform` –∏ `context.DATA.authorizationDecision` –ø–æ–ª—É—á–∞—é—Ç —Å—Ç—Ä–æ–≥—É—é —Ç–∏–ø–∏–∑–∞—Ü–∏—é –±–µ–∑ `as`/`satisfies`:

Route | Result type `R` | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è
:--|:--|:--
`onBeforeCreate` / `onBeforeGet` / `onBeforePartialUpdate` / `onBeforeUpdate` | `E`
`onBeforeDelete` | `void`
`onBeforeGetList` | `IApiGetListResponseResult<E>`
Custom actions | `TApiAuthorizationRuleTransformPayload<E>` (fallback)

```typescript filename="policies/challenge.policy.ts" copy
onBeforeGet() {
	return this.allow({
		resultTransform: (challenge, { context, subject }) => {
			// challenge: Challenge
			// context.DATA.authorizationDecision: IApiAuthorizationDecision<Challenge, Challenge>
			if (!subject.roles.includes("admin")) {
				challenge.secretKey = undefined;
			}

			return challenge;
		},
	});
}
```

- DELETE –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `void`, –ø–æ—ç—Ç–æ–º—É —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å –ø–æ–±–æ—á–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏.
- –î–ª—è –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π union ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å —Ç–∏–ø –≤—Ä—É—á–Ω—É—é, —É–∫–∞–∑–∞–≤ `this.allow<TCustomResult>({ ... })`.

## No Controller Configuration

Controller metadata no longer needs any `authorization` flags. The guard:

1. Resolves the entity from controller metadata
2. Infers the action from the handler name
3. Builds/loads the aggregated policy from the registry
4. Resolves the subject from `request.user` with smart fallbacks (`id`, `uuid`, `email`, roles, permissions)
5. Applies scope + transforms to the generated methods

Decisions are stored on the request and injected into subscriber contexts, so you can inspect `context.DATA.authorizationDecision` inside existing hooks.

## Migration Tips

Existing manual guards can be phased out gradually:

1. Import `ApiAuthorizationModule`.
2. Implement policies using helper methods (`allowForRoles`, `scopeToOwner`, etc.).
3. Remove legacy controller configuration (no `authorization` blocks required).

See the [API Reference](/docs/nestjs-crud-automator/api-reference/decorators#apiauthorizationpolicy) for the complete contract and helper methods exposed by `ApiAuthorizationPolicyBase`.


